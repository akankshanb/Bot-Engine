---
- hosts: localhost
  gather_facts: no
  vars:
      instance_type: t2.micro
      image: ami-0d5d9d301c853a04a
      region: us-east-2
      keypair: plotbot-key
      subnet: subnet-92d08ce8
      sg_group: sg-0c097f91462118199
  vars_files:
    - plotbot_vault.yaml
  tasks:
    - name: Install EC2 dependencies
      pip:
        name: ['boto', 'boto3', 'botocore']

    - name: Check that the {{keypair}}.pem exists
      stat:
        path: "~/.aws/{{keypair}}.pem"
      register: key_exists

    - name: create a new ec2 key pair, returns generated private key
      ec2_key:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        name: "{{keypair}}"
        region: "{{region}}"
      register: ec2_priv
      when: key_exists.stat.exists == False
    
    - local_action: copy content={{ ec2_priv.key.private_key }} dest=~/.aws/{{keypair}}.pem
      when: key_exists.stat.exists == False

    - name: Change permission of key file
      shell: "chmod 400 ~/.aws/{{keypair}}.pem"

    - debug:
        msg: "{{ec2_priv}}"

    # - name: Install EC2 dependencies
    #   pip:
    #     name: ['boto', 'boto3', 'botocore']
    - name: Launch the new EC2 Instance
      ec2_instance:
        name: plotbot1
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        instance_type: "{{instance_type}}"
        image_id: "{{image}}"
        wait: yes 
        region: "{{region}}"
        key_name: "{{keypair}}"
        vpc_subnet_id: "{{subnet}}"
        security_group: "{{sg_group}}"
        network:
          assign_public_ip: true
      register: ec2

    - name: Add the newly created host
      add_host:
        name: "{{ ec2.instances[0].public_ip_address }}"
        groups: Botserver
        ansible_ssh_private_key_file: "~/.aws/{{keypair}}.pem"
    
    - name: Wait for SSH to come up
      wait_for:
        host: "{{ ec2.instances[0].public_ip_address }}"
        port: 22
        state: started

- hosts: Botserver
  remote_user: ubuntu
  become: yes
  gather_facts: no
  pre_tasks:
    - name: 'install python3'
      raw: 'sudo apt-get -y install python3'
#   # tasks:
#   #   - name: Install Apache
#   #     apt:
#   #       name: apache2
#   #       state: present
#   #   - service: 
#   #       name: apache2
#   #       state: started
#   #       enabled: yes

#     # - debug:
#     #   msg: "{{ec2}}"
    
#     # - name: Export TOKEN
#     # - name: Run Application
#     #   shell: |
#     #     cd ../plotbot/
#     #     export PLOT_BOT_TOKEN={{PLOT_BOT_TOKEN}}
#     #     python3 bot-engine.py
#     # - name: Printing the environmentâ€‹ variable in Ansible
#     #   debug:
#     #     msg: "{{ lookup('env','PLOT_BOT_TOKEN') }}"
#     # - name: Launch Flask Application
#     #   command: python3 bot-engine.py
#     #   args:
#     #     chdir: ../plotbot/
    

